<!DOCTYPE html>
<html>
<title>Tic-Tac-Toe</title>

<style type="text/css">
	body {
		background-color: darkslategrey;
		padding-top: 5rem;

	}
	.body{
	    display: flex;
	    flex-direction: row;
	    align-items: center;
	    justify-content: center;
	}
	h1{
		text-align: center;
    	font-size: -webkit-xxx-large;
	}
	#PlayersContainer {
		padding-left: 3rem;
	}
	#canvas {
		border: solid;
   		background-color: white;
	}
	#message {
	    color: red;
	    align-content: center;
	    position: absolute;
	    top: 35rem;
	    left: 48rem;
	}
	input{
		width: 100%;
		padding: 1rem;
	}
	#player{
		font-size: 20px;
	}

</style>

<body>

<h1>Tic Tac Toe </h1>
<div class="body">
	<canvas id="canvas" width="300" height="300">
	</canvas>
	<div id="PlayersContainer">
		<p id="player">Player1: </p><input id="player1" value="Player1" type="input"/> 
		<p id="player">Player2:  </p>
		<input id="player2" value="Player2" type="input"/>
	</div>

	<p id="message"></p>
</div>
<script type="text/javascript">
	
var canvas = document.getElementById('canvas');

if(!canvas) {
	console.error("ERROR: Canvas is undefined!");
}

const NR_OF_TILES = 9;
const TILE_SIZE = canvas.width / 3 - 5;
const OFFSET = 2.5;
const CELL_X = canvas.width / 3;
const CELL_Y = canvas.height / 3;

const message = document.getElementById("message");
const player1Name = document.getElementById("player1");
const player2Name = document.getElementById("player2");
const imgX = document.createElement("img");
const imgO = document.createElement("img");
imgX.src = "https://www.pngkit.com/png/detail/205-2056266_player-o-into-tic-tac-toe-img-tic.png";
imgO.src = "https://www.pngkey.com/png/detail/205-2056274_tic-tac-toe-img-letter-o.png";

var rects = [];
var oHistory = {
	oMovedTiles: [],
	xMovedTiles: [],
	tilesUsed: []
};
var turn = 0;

createGrid();
drawGrid();

function createGrid(){
	var canvas = document.getElementById('canvas');

	var nextRow = 0;
	var nextColumn = 0;
	for (var i = 0; i < NR_OF_TILES; i++) {
		if(i !== 0 && i % 3 === 0) {
			nextRow += 1;
			nextColumn = 0;
		}

		if(i % 3 !== 0) {
			nextColumn += 1;
		}

		rects.push({
			x: nextRow * CELL_X + OFFSET,
			y: nextColumn * CELL_Y + OFFSET,
			w: TILE_SIZE,
			h: TILE_SIZE
		});
	}
}

function drawGrid() {
	var canvas = document.getElementById('canvas');
	var context;

	if(!canvas) {
		console.error("ERROR: Canvas is undefined!");
		return
	}

	context = canvas.getContext('2d');

	if(!context) {
		console.error("ERROR: Context is undefined!");
		return;
	}

	for (var i = 0; i < rects.length; i++) {
		context.fillRect(rects[i].x, rects[i].y, rects[i].w, rects[i].h);
	}

	canvas.onclick = evt => {
		var clickedRect = getClickedRect(evt.offsetX, evt.offsetY);

		if(clickedRect != null) {			
			if(oHistory.tilesUsed.includes(clickedRect)) {
				return;
			}

			if(turn === -1) {
				return;
			}

			oHistory.tilesUsed.push(clickedRect);

			if(turn == 0) {
				context.drawImage(imgX, clickedRect.x, clickedRect.y, clickedRect.w, clickedRect.h);
				message.innerHTML = getPlayerName() + "'s turn!";
				turn = 1;
				oHistory.xMovedTiles.push(clickedRect);
				checkGameState();
			} else {
				context.drawImage(imgO, clickedRect.x, clickedRect.y, clickedRect.w, clickedRect.h);
				message.innerHTML = getPlayerName() + "'s turn!";
				turn = 0;
				oHistory.oMovedTiles.push(clickedRect);
				checkGameState();
			}

		}
	}
}

function getClickedRect(xOffset, yOffset) {
	for (var i = 0; i < rects.length; i++) {
		if(xOffset <= rects[i].x + rects[i].w
			&& xOffset >= rects[i].x
			&& yOffset <= rects[i].y + rects[i].h
			&& yOffset >= rects[i].y) {
			console.log("LOG: Rectangle " + i + " is clicked!");
			return rects[i];
		}
	}

	return null;
}

function checkGameState() {
	var lastCheckedTile;
	var countXInRow = 0;
	var countXInColumn = 0;
	var countOInRow = 0;
	var countOInColumn = 0;

	if(oHistory.xMovedTiles) {
		for (var i = 0; i < oHistory.xMovedTiles.length; i++) {
			if(lastCheckedTile) {
				if (oHistory.xMovedTiles[i].x === lastCheckedTile.x) {
					lastCheckedTile = oHistory.xMovedTiles[i];
					countXInRow++;
				}

				if(oHistory.xMovedTiles[i].y === lastCheckedTile.y) {
					lastCheckedTile = oHistory.xMovedTiles[i];
					countXInColumn++;
				}
			}
			lastCheckedTile = oHistory.xMovedTiles[i];
		}		
	}

	lastCheckedTile = null;

	if(oHistory.oMovedTiles) {
		for (var i = 0; i < oHistory.oMovedTiles.length; i++) {
			if(lastCheckedTile) {
				if (oHistory.oMovedTiles[i].x === lastCheckedTile.x) {
					lastCheckedTile = oHistory.oMovedTiles[i];
					countOInRow++;
				}

				if(oHistory.oMovedTiles[i].y === lastCheckedTile.y) {
					lastCheckedTile = oHistory.oMovedTiles[i];
					countOInColumn++;
				}
			}
			lastCheckedTile = oHistory.oMovedTiles[i];
		}		
	}



	if(countXInRow === 2 || countOInRow == 2 || countXInColumn == 2 || countOInColumn == 2) {
		console.log("Game WON!!!");
		message.innerHTML = getLastPlayedName() + " has won the game!";
		turn = -1;
	}
}

function getPlayerName() {
	if(turn === 0) {
		return player1Name.value;
	}

	return player2Name.value;
}

function getLastPlayedName() {
	if(turn === 0) {
		return player2Name.value;
	}

	return player1Name.value;
}

</script>

</body>
</html>